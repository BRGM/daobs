<!--
  ~ Copyright 2014-2016 European Environment Agency
  ~
  ~ Licensed under the EUPL, Version 1.1 or â€“ as soon
  ~ they will be approved by the European Commission -
  ~ subsequent versions of the EUPL (the "Licence");
  ~ You may not use this work except in compliance
  ~ with the Licence.
  ~ You may obtain a copy of the Licence at:
  ~
  ~ https://joinup.ec.europa.eu/community/eupl/og_page/eupl
  ~
  ~ Unless required by applicable law or agreed to in
  ~ writing, software distributed under the Licence is
  ~ distributed on an "AS IS" basis,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
  ~ either express or implied.
  ~ See the Licence for the specific language governing
  ~ permissions and limitations under the Licence.
  -->
<beans:beans
  xmlns:beans="http://www.springframework.org/schema/beans"
  xmlns:ctx="http://www.springframework.org/schema/context"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.springframework.org/schema/security"

  xsi:schemaLocation="http://www.springframework.org/schema/beans
  http://www.springframework.org/schema/beans/spring-beans.xsd
  http://www.springframework.org/schema/context
  http://www.springframework.org/schema/context/spring-context.xsd
  http://www.springframework.org/schema/security
  http://www.springframework.org/schema/security/spring-security-4.0.xsd">

  <ctx:property-placeholder location="${config.properties.path}"
                            file-encoding="UTF-8"
                            ignore-unresolvable="false"/>

  <!--<ldap-server ldif="classpath:test-server.ldif" />-->
  <ldap-server url="${ldap.base.provider.url}/${ldap.base.dn}"
               manager-dn="${ldap.security.principal}"
               manager-password="${ldap.security.credentials}"/>

  <http auto-config="true" entry-point-ref="httpAuthenticationEntryPoint">
    <intercept-url pattern="/daobs/loginForm" access="permitAll" />
    <intercept-url pattern="/daobs/userDetails" access="permitAll"/>
    <intercept-url pattern="/login" access="permitAll" />
    <intercept-url pattern="/assets/**" access="permitAll" />
    <intercept-url pattern="/app/**" access="permitAll" />
    <intercept-url pattern="/favicon.ico" access="permitAll" />
    <intercept-url pattern="/" access="permitAll"/>
    <intercept-url pattern="/**" access="permitAll" />

    <form-login login-page="/daobs/loginForm"
                authentication-success-handler-ref="authSuccessHandler"
                authentication-failure-handler-ref="authFailureHandler"
                default-target-url="/" />
    <logout success-handler-ref="httpLogoutSuccessHandler"/>
    <csrf disabled="false" token-repository-ref="csrfTokenRepository"/>
    <custom-filter ref="csrfHeaderFilter" after="CSRF_FILTER"/>

  </http>


  <authentication-manager>
    <ldap-authentication-provider
      user-search-base="${ldap.base.search.base}"
      user-search-filter="${ldap.base.dn.pattern}"
    />
  </authentication-manager>
<!--
  <ldap-user-service
    user-search-base="ou=people"
    user-search-filter="uid={0}"
  />-->

  <beans:bean id="csrfHeaderFilter" class="org.daobs.filter.CsrfHeaderFilter" />
  <beans:bean id="csrfTokenRepository" class="org.springframework.security.web.csrf.HttpSessionCsrfTokenRepository">
    <beans:property name="headerName" value="X-XSRF-TOKEN"/>
  </beans:bean>

</beans:beans>
